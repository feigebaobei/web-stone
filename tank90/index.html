<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>90 tank</title>
	<style type="text/css">
		body {
			margin: 0;
			width: 100vw;
			height: 100vh;
		}
		#canvas {
			margin: 0 auto;
			display: block;
			/*border: 1px solid #234;*/
			box-sizing: border-box;
		}
	</style>
</head>
<body>
	<canvas id="canvas">您的浏览器不支持本游戏！</canvas>
	<script type="text/javascript" src="./canvasCore.js"></script>
	<script type="text/javascript">
		let canvas = document.querySelector('#canvas')
		let context = canvas.getContext('2d')
		let {log} = console
		let bodyDom = document.querySelector('body')
		let [bodyW, bodyH] = [bodyDom.clientWidth, bodyDom.clientHeight]
		let edgeLength = Math.min(bodyW, bodyH)
		canvas.width = edgeLength
		canvas.height = edgeLength

		let tankCanvas = document.createElement('canvas')
		tankCanvas.width = edgeLength
		tankCanvas.height = edgeLength
		let tankContext = tankCanvas.getContext('2d')
		context.rect(0, 0, edgeLength, edgeLength)
		// // context.fillStyle = 'grey'
		context.strokeStyle = 'red'
		// // context.fill()
		context.stroke()

		let tank = new Sprite({
			name: 'tank',
			left: 50,
			top: 50,
			vx: 30,
			width: 25,
		}, {
			paint: (sprite, context) => {
				context.save()
				// 底壳
				context.strokeStyle = '#222'
				context.beginPath()
				context.rect(edgeLength * 0.1, edgeLength * 0.1, edgeLength * 0.8, edgeLength * 0.85)
				context.fillStyle = '#333'
				context.fill()
				context.stroke()
				// 履带
				context.beginPath()
				context.fillStyle = '#666'
				context.rect(0, 0, edgeLength * 0.25, edgeLength)
				context.rect(edgeLength * 0.75, 0, edgeLength * 0.25, edgeLength)
				context.fill()
				context.stroke()
				context.beginPath()
				context.fillStyle = '#777'
				context.rect(edgeLength * 0.025, edgeLength * 0.05, edgeLength * 0.2, edgeLength * 0.1)
				context.rect(edgeLength * 0.025, edgeLength * 0.24, edgeLength * 0.2, edgeLength * 0.1)
				context.rect(edgeLength * 0.025, edgeLength * 0.43, edgeLength * 0.2, edgeLength * 0.1)
				context.rect(edgeLength * 0.025, edgeLength * 0.62, edgeLength * 0.2, edgeLength * 0.1)
				context.rect(edgeLength * 0.025, edgeLength * 0.81, edgeLength * 0.2, edgeLength * 0.1)
				context.rect(edgeLength * 0.775, edgeLength * 0.05, edgeLength * 0.2, edgeLength * 0.1)
				context.rect(edgeLength * 0.775, edgeLength * 0.24, edgeLength * 0.2, edgeLength * 0.1)
				context.rect(edgeLength * 0.775, edgeLength * 0.43, edgeLength * 0.2, edgeLength * 0.1)
				context.rect(edgeLength * 0.775, edgeLength * 0.62, edgeLength * 0.2, edgeLength * 0.1)
				context.rect(edgeLength * 0.775, edgeLength * 0.81, edgeLength * 0.2, edgeLength * 0.1)
				context.fill()
				context.stroke()
				// 机舱
				context.beginPath()
				context.fillStyle = '#bbb'
				context.rect(edgeLength * 0.1, edgeLength * 0.15, edgeLength * 0.8, edgeLength * 0.8)
				context.fill()
				context.stroke()
				// 炮塔
				context.beginPath()
				context.fillStyle = '#ddd'
				context.rect(edgeLength * 0.3, edgeLength * 0.4, edgeLength * 0.4, edgeLength * 0.4)
				context.fill()
				context.stroke()
				context.beginPath()
				context.fillStyle = '#eee'
				context.arc(edgeLength * 0.5, edgeLength * 0.6, edgeLength * 0.18, 0, 2*Math.PI, true)
				context.fill()
				context.stroke()
				context.beginPath()
				context.fillStyle = '#eee'
				context.rect(edgeLength * 0.45, 0, edgeLength * 0.1, edgeLength * 0.5)
				context.fill()
				context.stroke()
				context.beginPath()
				// 炮塔
				context.fill()
				context.stroke()
				context.restore()
			}
		}, [{
			execute: function (sprite, context, fps) {
				sprite.left += sprite.vx * fps / 1000
				if (sprite.left > edgeLength) {
					sprite.left = 50
				}
			}
		}])

		tank.paint(tankContext)

		let lastTimeForCalcFps = 0
		const calcFps = () => {
			let now = +new Date()
			let fps = 1000 / (now - lastTimeForCalcFps)
			lastTimeForCalcFps = now
			return fps
		}
		let fps, animateId

		context.drawImage(tankCanvas, 0, 0, edgeLength, edgeLength, 10, 10, edgeLength * 0.1, edgeLength * 0.1)

		let draw = () => {
			log('draw')
			tank.paint(tankContext)
			tank.update(context, fps)
		}
		let animate = (time) => {
			context.clearRect(0, 0, edgeLength, edgeLength)
			fps = calcFps()
			draw()
			animateId = requestNextAnimateionFrame(animate)
		}
		let start = () => {
			animateId = requestNextAnimateionFrame(animate)
		}
		let stop = () => {
			cancelNextAnimationFrame(animateId)
		}
		let flag = false
		canvas.onclick = (e) => {
			flag = !flag
			if (flag) {
				start()
			} else {
				stop()
			}
		}

		tank.paint(tankContext)

		let game = new Game('tank90', '#canvas')
		game.setKeyListener(38, (e) => {
			log(38, '上', e)
		})
		game.setKeyListener(40, (e) => {
			log(40, '下', e)
		})
		game.setKeyListener(37, (e) => {
			log(37, '左', e)
		})
		game.setKeyListener(39, (e) => {
			log(39, '右', e)
		})
		log(game)

		// log(tank)

	</script>
</body>
</html>